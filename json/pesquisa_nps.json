{
  "name": "Pesquisa Satisfa√ß√£o NPS",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 10 * * *"
            }
          ]
        }
      },
      "id": "cron-nps",
      "name": "Cron Di√°rio 10h",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "url": "=http://localhost:4000/api/consultas/realizadas-ontem",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.BACKEND_API_TOKEN }}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-completed",
      "name": "Buscar Consultas Realizadas Ontem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [460, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_BACKEND_API_AUTH_ID",
          "name": "Backend API Auth"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-completed",
      "name": "Dividir Consultas",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "phoneNumberId": "={{ $env.WHATSAPP_PHONE_ID }}",
        "to": "={{ $json.paciente.telefone }}",
        "message": "‚≠ê *Pesquisa de Satisfa√ß√£o*\\n\\nüëã Ol√°, {{ $json.paciente.nome }}!\\n\\nEsperamos que sua consulta com Dr(a). {{ $json.profissional.nomeProfissional }} tenha sido excelente!\\n\\nüéØ *Sua opini√£o √© muito importante para n√≥s.*\\n\\nEm uma escala de 0 a 10, o quanto voc√™ recomendaria nossa cl√≠nica para um amigo ou familiar?\\n\\n*Responda apenas com um n√∫mero de 0 a 10: (Ex: 9)*\\n\\nüí¨ Ap√≥s sua nota, fique √† vontade para deixar um coment√°rio sobre sua experi√™ncia.\\n\\nüôè Obrigado pelo seu tempo! *ID da Consulta: {{ $json.id }}*",
        "additionalFields": {}
      },
      "id": "send-nps",
      "name": "Enviar Pesquisa NPS",
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [900, 300],
      "credentials": {
        "whatsAppBusinessCloud": {
          "id": "YOUR_WHATSAPP_CREDENTIAL_ID",
          "name": "WhatsApp Business Cloud"
        }
      }
    },
    {
      "parameters": {
        "url": "=http://localhost:4000/api/consultas/{{ $json.id }}/nps-enviado",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.BACKEND_API_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": [
          {
            "name": "nps_enviado",
            "value": "true"
          },
          {
            "name": "data_nps_enviado",
            "value": "={{ new Date().toISOString() }}"
          }
        ],
        "options": {}
      },
      "id": "update-nps-status",
      "name": "Atualizar Status NPS",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_BACKEND_API_AUTH_ID",
          "name": "Backend API Auth"
        }
      }
    }
  ],
  "connections": {
    "Cron Di√°rio 10h": {
      "main": [
        [
          {
            "node": "Buscar Consultas Realizadas Ontem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Consultas Realizadas Ontem": {
      "main": [
        [
          {
            "node": "Dividir Consultas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir Consultas": {
      "main": [
        [
          {
            "node": "Enviar Pesquisa NPS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Pesquisa NPS": {
      "main": [
        [
          {
            "node": "Atualizar Status NPS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}