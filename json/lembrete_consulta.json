{
  "name": "Lembretes Consultas Di√°rios",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 18 * * *"
            }
          ]
        }
      },
      "id": "cron-daily",
      "name": "Cron Di√°rio 18h",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:4000/api/consultas/buscarProximasConsultas",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": [
          {
            "name": "Authorization",
            "value": "Bearer {{ $env.BACKEND_API_TOKEN }}"
          }
        ],
        "sendQuery": true,
        "queryParameters": [  
          {
            "name": "clientId",
            "value": "minha_clinica_teste_id"
          },
          {
            "name": "data",
            "value": "={{ new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0] }}"
          },
          {
            "name": "status",
            "value": "AGENDADA"
          }
        ],
        "options": {}
      },
      "id": "buscar-consultas-amanha",
      "name": "Buscar Consultas Amanh√£",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [460, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "hLqrUhAwdSuSf2LS",
          "name": "AuthBackendClinica"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "dividir-consultas",
      "name": "Dividir Consultas",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:4000/api/whatsapp/sendMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": [
          {
            "name": "Authorization",
            "value": "Bearer {{ $env.BACKEND_API_TOKEN }}"
          }
        ],
        "sendBody": true,
        "bodyParameters": [  
          {
            "name": "clientId",
            "value": "={{ $('Buscar Consultas Amanh√£').first().json.clientId || 'minha_clinica_teste_id' }}"
          },
          {
            "name": "to",
            "value": "={{ $json.paciente.telefone }}"
          },
          {
            "name": "message",
            "value": "üîî *Lembrete de Consulta*\\n\\nüëã Ol√°, {{ $json.paciente.nome }}!\\n\\nüìÖ Voc√™ tem uma consulta agendada para *amanh√£*:\\n\\nüïê *Hor√°rio:* {{ new Date($json.data_hora_inicio).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) }}\\nüë®‚Äç‚öïÔ∏è *Profissional:* Dr(a). {{ $json.profissional.nome_profissional }}\\nüè• *Local:* {{ $json.telemedicina ? 'Telemedicina' : 'Presencial - Verifique no agendamento' }}\\n\\n‚ö†Ô∏è *Lembrete importante:*\\n‚Ä¢ Chegue 15 minutos antes\\n‚Ä¢ Traga documento com foto\\n‚Ä¢ Para cancelar, avise com 1 hora de anteced√™ncia\\n\\nüìû D√∫vidas? {{ $env.CLINIC_PHONE }}\\n\\n‚úÖ Responda *SIM {{ $json.id_consulta }}* para confirmar presen√ßa\\n‚ùå Responda *CANCELAR {{ $json.id_consulta }}* se n√£o puder comparecer"
          }
        ],
        "options": {}
      },
      "id": "enviar-lembrete",
      "name": "Enviar Lembrete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "hLqrUhAwdSuSf2LS",
          "name": "AuthBackendClinica"
        }
      }
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:4000/api/consultas/{{ $json.id_consulta }}/lembrete-enviado",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": [
          {
            "name": "Authorization",
            "value": "Bearer {{ $env.BACKEND_API_TOKEN }}"
          },
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ],
        "sendBody": true,
        "bodyParameters": [  
          {
            "name": "clientId",
            "value": "={{ $('Buscar Consultas Amanh√£').first().json.clientId || 'minha_clinica_teste_id' }}"
          },
          {
            "name": "lembrete_enviado",
            "value": "true"
          },
          {
            "name": "data_lembrete",
            "value": "={{ new Date().toISOString() }}"
          }
        ],
        "options": {}
      },
      "id": "atualizar-status-lembrete",
      "name": "Atualizar Status Lembrete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "hLqrUhAwdSuSf2LS",
          "name": "AuthBackendClinica"
        }
      }
    }
  ],
  "connections": {
    "Cron Di√°rio 18h": {
      "main": [
        [
          {
            "node": "Buscar Consultas Amanh√£",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Consultas Amanh√£": {
      "main": [
        [
          {
            "node": "Dividir Consultas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir Consultas": {
      "main": [
        [
          {
            "node": "Enviar Lembrete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Lembrete": {
      "main": [
        [
          {
            "node": "Atualizar Status Lembrete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}